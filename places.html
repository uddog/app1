<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSV Profiles</title>
<link rel="stylesheet" href="test.css">
<link rel="stylesheet" href="universal.css">
<link rel="stylesheet" href="navbar.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    
    <!--NavBar Start-->
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-top" id="sidebarTop"></div>
        <a href="#" onclick="toggleSidebar()" class="close-btn">&times;</a>
        <a href="index.html" id="homeLink">Home</a>
        <a href="inbox.html">Inbox</a>
        <a href="profiles.html" id="profileBtn">Profile</a>
        <a href="settings.html">Settings</a>
        <a href="#" onclick="openLogoutPopup()" id="logoutBtn">Log Out</a>
    </div>
    <!-- Main content -->
    <header>
        <div>
            <div class="menu-icon" id="sidebarButton" onclick="toggleSidebar()">&#9776;</div>
        </div>
        <nav id="navbar">
        </nav>
    </header>

    <!-- Bio section -->
    <div class="bio-section" id="bioSection" style="display: none;">
    </div>

    <!-- Logout Popup -->
    <div class="overlay" id="overlay" onclick="closeLogoutPopup()"></div>
    <div class="popup" id="logoutPopup">
        <p>Are you sure you want to logout?</p>
        <a style="color: black;" href="index.html"><button onclick="logout()">Yes</button></a>  
        <button onclick="closeLogoutPopup()">No</button>
    </div>    
    <!--NavBar End-->


<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Search by profile name">
</div>
<div id="profilesContainer"></div>
<script src="universal.js"></script>
<script src="navbar.js"></script>
<script>
    
    const catName = localStorage.getItem('CatName');
    const storedData = localStorage.getItem('CSVData');
    let csvData = storedData ? JSON.parse(storedData) : null;
    let lastFetchTime = localStorage.getItem('LastFetchTime') || 0;
    const fetchInterval = 10 * 60 * 1000; // 10 minutes in milliseconds
    const csvURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMec3rLMJvXIWdyVxO_ZVzKaJTrxrxqp4Wk1G2jjzEbRAr2x0df81w-6C3UrYpgNgilUTmz_ct4seU/pub?output=csv&gid=622627727';

    // Function to handle the CSV data
    function handleCSVData(results) {
        csvData = results.data;
        localStorage.setItem('CSVData', JSON.stringify(csvData));
        localStorage.setItem('LastFetchTime', Date.now());
        renderProfiles();
    }

    // Function to render profiles based on stored CSV data
    function renderProfiles() {
        if (csvData) {
            var profilesHTML = '';
            for (var i = 1; i < csvData.length; i++) {
                var profileType = csvData[i][3].trim(); // Profile type from column D
                if (profileType === catName.trim()) {
                    var profileName = csvData[i][1].trim(); // Profile name from column B
                    var profileImgSrc = csvData[i][7].trim(); // Image source from column H
                    var profileAddress = csvData[i][6].trim(); // Address from column G
                    var profilePhone = csvData[i][4].trim(); // Phone number from column E
                    var profileLink = csvData[i][11].trim(); // Link from column L
        
                    profilesHTML += `
                        <div class="profile">
                            <div class="two">
                                <img src="${profileImgSrc}" alt="${profileName}">
                                <div class="one">
                                    <h2>${profileName}</h2>
                                    ${profileAddress ? `<p class="address">ঠিকানা : ${profileAddress}</p>` : ''}
                                    ${profilePhone ? `<p class="phone">যোগাযোগ : ${profilePhone}</p>` : ''}
                                </div>
                            </div>
                            ${profileLink ? `<button class="see-more" onclick="storePlaceName('${profileName}', '${profileLink}')">See more</button>` : ''}
                        </div>`;
                }
            }
            document.getElementById('profilesContainer').innerHTML = profilesHTML;
        }
    }

    // Function to store profile name in localStorage
    function storePlaceName(placeName, link) {
        localStorage.setItem('PlaceName', placeName);
        window.location.href = link;
    }

    // Function to search profiles by name
    function searchProfiles() {
        var input, filter, profiles, profile, i, txtValue;
        input = document.getElementById('searchInput');
        filter = input.value.toUpperCase();
        profiles = document.getElementsByClassName('profile');

        for (i = 0; i < profiles.length; i++) {
            profile = profiles[i].getElementsByClassName('one')[0]; // Get the div containing profile details
            txtValue = profile.textContent || profile.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                profiles[i].style.display = ''; // Show the profile if the search term matches
            } else {
                profiles[i].style.display = 'none'; // Hide the profile if the search term does not match
            }
        }
    }
  
    // Function to fetch and parse CSV data
    function fetchAndParseCSV() {
        Papa.parse(csvURL, {
            download: true,
            complete: function(results) {
                handleCSVData(results);
            }
        });
    }

    // Call fetchAndParseCSV() when the page loads
    window.onload = function() {
        renderProfiles();
        fetchIfRequired();
        // Attach event listener to the input field for instant search
        document.getElementById('searchInput').addEventListener('input', searchProfiles);
    };

    // Check if a fetch is required based on the last fetch time
    function fetchIfRequired() {
        if (Date.now() - lastFetchTime > fetchInterval) {
            fetchAndParseCSV();
        }
    }

    // Periodically fetch CSV data every 10 minutes
    setInterval(fetchIfRequired, fetchInterval);
</script>
</body>
</html>
